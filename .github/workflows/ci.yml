# .github/workflows/ci.yml
name: Flutter CI/CD for GitHub Actions

# –ö–æ–Ω—Ç—Ä–æ–ª–∏—Ä—É–µ—Ç, –∫–æ–≥–¥–∞ –±—É–¥–µ—Ç –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –≤–æ—Ä–∫—Ñ–ª–æ—É
on:
  push:
    branches:
      - main  # –∏–ª–∏ –≤–∞—à–∞ –æ—Å–Ω–æ–≤–Ω–∞—è –≤–µ—Ç–∫–∞
    tags:
      - 'v*.*.*'  # –ó–∞–ø—É—Å–∫ –¥–ª—è —Ç–µ–≥–æ–≤, –Ω–∞–ø—Ä–∏–º–µ—Ä v1.2.3
  pull_request:
    branches:
      - main

jobs:
  # –ó–∞–¥–∞—á–∞ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–¥–∞
  test:
    name: "üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ"
    runs-on: ubuntu-latest

    steps:
      - name: "üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        uses: actions/checkout@v3

      - name: "üê¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Flutter"
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        run: flutter pub get

      - name: "üî¨ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤"
        run: flutter test

  # –ó–∞–¥–∞—á–∞ –¥–ª—è —Å–±–æ—Ä–∫–∏ Android-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  build_android:
    name: "üî® –°–±–æ—Ä–∫–∞ Android"
    needs: test # –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è 'test'
    runs-on: ubuntu-latest

    steps:
      - name: "üõéÔ∏è –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è"
        uses: actions/checkout@v3

      - name: "üê¶ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Flutter"
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'

      - name: "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π"
        run: flutter pub get

      # –î–ª—è —Ä–µ–ª–∏–∑–Ω–æ–π —Å–±–æ—Ä–∫–∏ (–ø—Ä–∏ –ø—É—à–µ —Ç–µ–≥–∞) –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–æ–¥–ø–∏—Å—å.
      # –°–æ–∑–¥–∞–π—Ç–µ —Å–µ–∫—Ä–µ—Ç—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è: Settings -> Secrets and variables -> Actions
      # 1. KEYSTORE_BASE64: –≤–∞—à .jks —Ñ–∞–π–ª, –∑–∞–∫–æ–¥–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≤ base64
      # 2. KEY_ALIAS: –∞–ª–∏–∞—Å –≤–∞—à–µ–≥–æ –∫–ª—é—á–∞
      # 3. STORE_PASSWORD: –ø–∞—Ä–æ–ª—å –æ—Ç —Ö—Ä–∞–Ω–∏–ª–∏—â–∞ –∫–ª—é—á–µ–π
      # 4. KEY_PASSWORD: –ø–∞—Ä–æ–ª—å –æ—Ç —Å–∞–º–æ–≥–æ –∫–ª—é—á–∞
      - name: "üîë –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Keystore –¥–ª—è —Ä–µ–ª–∏–∑–∞"
        if: startsWith(github.ref, 'refs/tags/v')
        run: |
          echo "${{ secrets.KEYSTORE_BASE64 }}" | base64 --decode > android/app/upload-keystore.jks
          echo "storeFile=upload-keystore.jks" >> android/key.properties
          echo "keyAlias=${{ secrets.KEY_ALIAS }}" >> android/key.properties
          echo "storePassword=${{ secrets.STORE_PASSWORD }}" >> android/key.properties
          echo "keyPassword=${{ secrets.KEY_PASSWORD }}" >> android/key.properties
        
      - name: "üì± –°–±–æ—Ä–∫–∞ APK (Release)"
        if: startsWith(github.ref, 'refs/tags/v')
        run: flutter build apk --release

      - name: "üì¶ –°–±–æ—Ä–∫–∞ App Bundle (Release)"
        if: startsWith(github.ref, 'refs/tags/v')
        run: flutter build appbundle --release

      # –ó–∞–≥—Ä—É–∑–∫–∞ –∞—Ä—Ç–µ—Ñ–∞–∫—Ç–æ–≤ —Å–±–æ—Ä–∫–∏
      - name: "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ APK"
        uses: actions/upload-artifact@v3
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: app-release.apk
          path: build/app/outputs/flutter-apk/app-release.apk

      - name: "‚¨ÜÔ∏è –ó–∞–≥—Ä—É–∑–∫–∞ App Bundle"
        uses: actions/upload-artifact@v3
        if: startsWith(github.ref, 'refs/tags/v')
        with:
          name: app-release.aab
          path: build/app/outputs/bundle/release/app-release.aab

  # –ó–∞–¥–∞—á–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Ä–µ–ª–∏–∑–∞ –Ω–∞ GitHub
  release:
    name: "üéâ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–∞"
    needs: build_android
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v') # –ó–∞–ø—É—Å–∫–∞—Ç—å —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–≥–æ–≤

    steps:
      # –ó–∞–≥—Ä—É–∂–∞–µ–º –∞—Ä—Ç–µ—Ñ–∞–∫—Ç—ã –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –∑–∞–¥–∞—á–∏
      - name: "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ APK"
        uses: actions/download-artifact@v3
        with:
          name: app-release.apk
      - name: "‚¨áÔ∏è –°–∫–∞—á–∏–≤–∞–Ω–∏–µ App Bundle"
        uses: actions/download-artifact@v3
        with:
          name: app-release.aab

      # –°–æ–∑–¥–∞–µ–º —Ä–µ–ª–∏–∑ –∏ –ø—Ä–∏–∫—Ä–µ–ø–ª—è–µ–º –∫ –Ω–µ–º—É —Ñ–∞–π–ª—ã
      - name: "üìù –°–æ–∑–¥–∞–Ω–∏–µ GitHub Release"
        uses: ncipollo/release-action@v1
        with:
          artifacts: "app-release.apk,app-release.aab"
          token: ${{ secrets.GITHUB_TOKEN }} # –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ç–æ–∫–µ–Ω, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ–º—ã–π GitHub
          body: "–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ä–µ–ª–∏–∑ –¥–ª—è —Ç–µ–≥–∞ ${{ github.ref_name }}"
          name: "–†–µ–ª–∏–∑ ${{ github.ref_name }}"
